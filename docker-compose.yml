# docker-compose.yml - CORRECTED for N-Green Strategy and Dynamic Port Management

services:
  # The Backend Service
  backend:
    build: ./backend
    # This port is INTERNAL to the Docker network.
    # Nginx will proxy to 'backend:5000'.
    # Use 'expose' for internal ports if Nginx is the only one accessing it from host.
    expose:
      - "5000" # Backend application should listen on port 5000 internally
    networks:
      - mynetwork

  # The Frontend Service
  frontend:
    build: ./frontend
    # This port is INTERNAL to the Docker network.
    # Nginx will proxy to 'frontend:3000'.
    expose:
      - "3000" # Frontend application should listen on port 3000 internally
    networks:
      - mynetwork

  # The Nginx Gateway
  nginx:
    build: ./nginx
    # THIS IS THE CRITICAL LINE FOR THE PYTHON SCRIPT
    # The '5000' on the host side will be dynamically replaced by our Python script
    # to the actual deploy port (e.g., 5000, 5001, etc.).
    # Nginx inside its container listens on port 80.
    ports:
      - "5000:80" # <--- Python script's 'sed' command targets and modifies this '5000'
    depends_on:
      - frontend
      - backend
    networks:
      - mynetwork

networks:
  mynetwork:
